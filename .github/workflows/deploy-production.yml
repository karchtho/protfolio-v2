name: Deploy to Production

# DÃ©clenchÃ© sur push vers main (aprÃ¨s merge de PR)
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub UI

# Permissions minimales
permissions:
  contents: read

jobs:
  # ============================================
  # JOB 1 : Deploy to VPS
  # ============================================
  deploy:
    name: Deploy to VPS OVH
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://karcherthomas.com

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout code
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Setup SSH key
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup SSH key

        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add server to known hosts
        run: echo "${{ secrets.VPS_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Deploy to VPS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy application
        env:
          SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
          SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          SSH_USER: ${{ secrets.VPS_SSH_USER }}
          PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e  # Exit on error

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸš€ Starting deployment..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Navigate to project directory
            cd ${{ secrets.VPS_PROJECT_PATH }}

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main

            # Stop services
            echo "ðŸ›‘ Stopping services..."
            docker compose -f docker-compose.prod.yml down

            # Rebuild images (important: uses local secrets/)
            echo "ðŸ”¨ Building Docker images..."
            docker compose -f docker-compose.prod.yml build --no-cache

            # Run database migrations
            echo "ðŸ—„ï¸  Running database migrations..."
            docker compose -f docker-compose.prod.yml up -d mysql
            sleep 10  # Wait for MySQL to be ready
            # Migrations run automatically via /docker-entrypoint-initdb.d/

            # Start all services
            echo "ðŸš€ Starting all services..."
            docker compose -f docker-compose.prod.yml up -d

            # Wait for services to be ready
            echo "â³ Waiting for services to be healthy..."
            sleep 20

            # Check service health
            echo "ðŸ¥ Checking service health..."
            docker compose -f docker-compose.prod.yml ps

            # Cleanup old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Verify deployment
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."

          # Check if site is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://karcherthomas.com)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Site is accessible (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Site returned HTTP $HTTP_STATUS"
            exit 1
          fi

          # Check API health endpoint
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://karcherthomas.com/api/health)

          if [ "$API_STATUS" -eq 200 ]; then
            echo "âœ… API is healthy (HTTP $API_STATUS)"
          else
            echo "âš ï¸  API health check failed (HTTP $API_STATUS)"
            # Don't fail deployment if API health endpoint doesn't exist yet

          fi

